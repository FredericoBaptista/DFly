import subprocess
import json
import os


current_dir = os.path.dirname(os.path.abspath(__file__))


def run_shell_script(script_path, dir_path):
    subprocess.run(["/bin/bash", script_path, dir_path])


def write_json_input(input_vec, file_path):
    with open(file_path, "w") as json_file:
        json.dump({"in": str(input_vec[0])}, json_file)


def read_json_output(file_path):
    with open(file_path, "r") as json_file:
        data = json.load(json_file)
    return int(data[0])


def poseidon1(input_vec):
    current_dir = os.getcwd()
    # Writes the input json
    write_json_input(input_vec, os.path.join(
        current_dir, "scripts/merkle_tree/Poseidon/poseidon1/poseidon1_js/input.json"))
    # Runs the shell script
    run_shell_script(os.path.join(
        current_dir, "scripts/merkle_tree/Poseidon/poseidon1/poseidon1.sh"), current_dir)

    # 'public.json' is the output file generated by the Circom circuit
    result = read_json_output(os.path.join(
        current_dir, "scripts/merkle_tree/Poseidon/poseidon1/public.json"))

    return result


def poseidon2(input_vec):
    with open(os.path.join(current_dir, "poseidon2/poseidon2_js/input.json"), "w") as json_file:
        json.dump({"left": str(input_vec[0]),
                  "right": str(input_vec[1])}, json_file)

    run_shell_script(os.path.join(
        current_dir, "poseidon2/poseidon2.sh"), current_dir)

    # 'public.json' is the output file generated by the Circom circuit
    result = read_json_output(os.path.join(
        current_dir, "poseidon2/public.json"))

    return result
